{% set local_ip = inventory_hostname %}
KUBE_APISERVER_OPTS="--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \
 --anonymous-auth=false \
 --bind-address={{ local_ip }} \
 --secure-port=6443 \
 --advertise-address={{ local_ip }} \
 --authorization-mode=Node,RBAC \
 --runtime-config=api/all=true \
 --enable-bootstrap-token-auth \
 --service-cluster-ip-range={{ service_cidr }} \
 --token-auth-file={{ k8s_dir }}/token.csv \
 --service-node-port-range={{ service_node_port_range }} \
 --tls-cert-file={{ k8s_dir }}/ssl/kube-apiserver.pem \
 --tls-private-key-file={{ k8s_dir }}/ssl/kube-apiserver-key.pem \
 --client-ca-file={{ k8s_dir }}/ssl/ca.pem \
 --kubelet-client-certificate={{ k8s_dir }}/ssl/kube-apiserver.pem \
 --kubelet-client-key={{ k8s_dir }}/ssl/kube-apiserver-key.pem \
 --service-account-key-file={{ k8s_dir }}/ssl/ca-key.pem \
 --service-account-signing-key-file={{ k8s_dir }}/ssl/ca-key.pem \
 --service-account-issuer=https://kubernetes.default.svc.cluster.local \
 --etcd-cafile={{ etcd_dir }}/ssl/ca.pem \
 --etcd-certfile={{ etcd_dir }}/ssl/etcd.pem \
 --etcd-keyfile={{ etcd_dir }}/ssl/etcd-key.pem \
 --etcd-servers={% for host in groups['etcd'] %}https://{{ hostvars[host].inventory_hostname }}:2379{% if not loop.last %},{% endif %}{% endfor %}\
 --allow-privileged=true \
 --apiserver-count=3 \
 --audit-log-maxage=30 \
 --audit-log-maxbackup=3 \
 --audit-log-maxsize=100 \
 --audit-log-path=/var/log/kube-apiserver-audit.log \
 --event-ttl=1h \
 --v=4"
